FROM public.ecr.aws/docker/library/node:18-slim

WORKDIR /app

# Copy package files first to leverage Docker caching
COPY package.json package-lock.json ./

# Install dependencies
RUN npm install

# Copy the rest of the application
COPY . .

# Create a non-root user
RUN useradd -m -s /bin/bash app && \
    chown -R app:app /app

# Set user
USER app

# Set PATH for npm global packages
ENV PATH="/home/app/.npm-global/bin:${PATH}"
ENV NPM_CONFIG_PREFIX="/home/app/.npm-global"